@page "/company/comments/{id}"
@attribute [Authorize(Policy = "Staff")]
@using Treks.Models
@using Treks.Services
@inject CompanyService service
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject AccessControlService accessControlService

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-danger" role="alert">@message</div>
}
else if (comments != null && comments.Any())
{
    foreach (var comment in comments)
    {
        <div class="comment">
            <div class="username">
                @if(@comment.ProfilePicture != null)
                {
                    <img src="data:image/jpeg;base64,@Convert.ToBase64String(comment.ProfilePicture)" width="30"
                        height="30" alt="Profile Picture" class="rounded-circle" />
                }
                @comment.FullName
            </div>
            <div>
                <p>@comment.TheComment</p>
            </div>
            
        </div>
    }
}
else
{
    <p>No comments available.</p>
}

@code {
    [Parameter]
    public string id { get; set; }

    private List<Comment> comments;
    private AccessContext accessContext = new AccessContext();
    private string message = "";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        accessContext = await accessControlService.GetAccessContextAsync(authState.User);

        int companyID = Convert.ToInt32(id); // Assuming id is the CompanyId as string
        if (!accessContext.CanAccessCompany(companyID))
        {
            message = "You are not authorized to view these comments.";
            comments = new List<Comment>();
            return;
        }
        comments = await service.GetCommentsByCompanyIdAsync(companyID);
    }
}
