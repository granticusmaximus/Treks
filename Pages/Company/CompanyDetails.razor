@page "/company/details/{id}"
@attribute [Authorize(Policy = "Staff")]
@using Treks.Models
@using Treks.Services
@using Treks.Pages.Company
@using Treks.Pages.Tickets
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Identity
@inject CompanyService companyService
@inject CompanyFileService companyFileService
@inject NavigationManager navigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject AccessControlService accessControlService
@inject UserManager<ApplicationUser> userManager

@if (!string.IsNullOrEmpty(message))
{
    <div class="alert alert-danger" role="alert">@message</div>
}
else if (company == null)
{
    <p>Loading...</p>
}
else
{
    <center>
        <div class="card">
            <div class="cardHeader"><h2>@company.Name Details</h2></div>
            <div class="cardBody">
                <strong>Contact Number:</strong> 
                <p>@Formatters.FormatPhone(company.ContactNumber)</p>
                <strong>Email:</strong> 
                <p>@company.Email</p>
                <strong>Location:</strong>
                <p> @company.Address,<br/> @company.City, @company.State</p>
            </div>
            <hr/>
            <div class="cardFooter">
                    
                    <button class="btn btn-success" @onclick="NavigateToList">Back to Company List</button> &nbsp;
                    @if (!string.IsNullOrEmpty(id))
                    {
                        var editCompanyUrl = $"/company/edit/{id}";
                        <NavLink class="btn btn-warning ml-2" href="@editCompanyUrl">
                            <span aria-hidden="true">Edit Company</span>
                        </NavLink>
                    }
            </div>
            <hr/>
        </div>
    </center>
}

<hr/>

@if (company != null)
{
    <div class="row mt-3">
        <div class="col-md-12">
            <h4>Assigned Users</h4>
            @if (company.AssignedUsers != null && company.AssignedUsers.Any())
            {
                <ul class="list-group">
                    @foreach (var assignedUser in company.AssignedUsers)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>@assignedUser.FullName (@(assignedUser.Role?.Name ?? "No Role"))</span>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p>No users assigned to this company.</p>
            }
        </div>
    </div>

    @if (accessContext.IsAdmin || accessContext.IsManager)
    {
        <div class="row mt-3">
            <div class="col-md-12">
                <h4>Assign Users to Company</h4>
                @if (!string.IsNullOrEmpty(assignMessage))
                {
                    <div class="alert alert-info">@assignMessage</div>
                }
                <button class="btn btn-primary mt-2" @onclick="OpenAssignUsersModal">Select Users</button>
            </div>
        </div>
    }
}

<hr/>

@if (company != null)
{
    <div class="row mt-3">
        <div class="col-md-12">
            <h4>Company Files</h4>
            @if (!string.IsNullOrEmpty(fileMessage))
            {
                <div class="alert alert-info">@fileMessage</div>
            }
            <div class="form-group">
                <label for="companyFiles">Upload Files</label>
                <InputFile id="companyFiles" OnChange="HandleCompanyFileSelected" multiple />
            </div>
            @if (companyFiles.Any())
            {
                <ul class="list-group mt-3">
                    @foreach (var file in companyFiles)
                    {
                        <li class="list-group-item d-flex align-items-center">
                            <img src="@DefaultFileIconUrl" alt="File" width="24" height="24" class="me-2" />
                            <a href="@file.FileUrl" target="_blank" class="me-auto">@file.FileName</a>
                            @if (accessContext.IsAdmin || accessContext.IsManager)
                            {
                                <button type="button" class="btn btn-sm btn-danger"
                                        @onclick="() => DeleteCompanyFile(file.Id)">
                                    Delete
                                </button>
                            }
                        </li>
                    }
                </ul>
            }
            else
            {
                <p>No files uploaded for this company.</p>
            }
        </div>
    </div>
}

<hr/>

<div class="row mt-3">
    <div class="col-md-6">
        <center>
            <button class="btn btn-primary mt-3" @onclick="OpenCommentModal">Add Comment</button>
        </center>

        <!-- Add New Comment Modal -->
        <div class="modal fade @(showCommentModal ? "show d-block" : "d-none")" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Comment</h5>
                        <button type="button" class="close" @onclick="CloseCommentModal">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <AddComment id="@id" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseCommentModal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <h3>Comments</h3>
        <Comments id="@id" />
    </div>
    <div class="col-md-6">
        <center>
            <button class="btn btn-primary mt-3" @onclick="OpenAddTicketModal">Add New Ticket</button> &nbsp;
        </center>
        
        <h3 class="mt-4">Active Tickets</h3>
        @if (tickets != null && tickets.Any())
        {
            <table class="table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Due Date</th>
                        <th>Severity</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ticket in tickets)
                    {
                        <tr>
                            <td>@ticket.Title</td>
                            <td>@ticket.DueDate.ToShortDateString()</td>
                            <td class="@GetSeverityCssClass(ticket.Severity.ToString()) text-uppercase text-white text-center" style="font-weight: 500">@ticket.Severity</td>
                            <td><button class="btn btn-primary" @onclick="() => ShowTicketDetails(ticket)"><span class="oi oi-eye" aria-hidden="true"></span></button></td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <p>No active tickets found.</p>
        }
    </div>
</div>

<!-- Ticket Details Modal -->
<div class="modal fade @(showTicketDetailsModal ? "show d-block" : "d-none")" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ticket Details</h5>
                <button type="button" class="close" @onclick="() => showTicketDetailsModal = false">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                @if (selectedTicket != null)
                {
                    <p><strong>Title:</strong> @selectedTicket.Title</p>
                    <p><strong>Description:</strong> @selectedTicket.Description</p>
                    <p><strong>Severity:</strong> @selectedTicket.Severity</p>
                    <p><strong>Due Date:</strong> @selectedTicket.DueDate.ToShortDateString()</p>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="() => showTicketDetailsModal = false">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add New Ticket Modal -->
        <div class="modal fade @(showAddTicketModal ? "show d-block" : "d-none")" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add New Ticket</h5>
                        <button type="button" class="close" @onclick="CloseAddTicketModal">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <CreateTicket />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseAddTicketModal">Close</button>
                    </div>
                </div>
            </div>
        </div>

@if (accessContext.IsAdmin || accessContext.IsManager)
{
    <div class="modal fade @(showAssignUsersModal ? "show d-block" : "d-none")" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Assign Users to Company</h5>
                    <button type="button" class="close" @onclick="CloseAssignUsersModal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="userSearch">Search Users</label>
                        <InputText id="userSearch" class="form-control" @bind-Value="userSearch" />
                    </div>
                    @if (FilteredUsers.Any())
                    {
                        <div class="list-group">
                            @foreach (var user in FilteredUsers)
                            {
                                <label class="list-group-item d-flex align-items-center">
                                    <input class="form-check-input me-2" type="checkbox"
                                           id="assign-@user.Id"
                                           checked="@selectedUserIds.Contains(user.Id)"
                                           @onchange="e => ToggleUserSelection(user.Id, e)" />
                                    <span>@user.LastName, @user.FirstName (@(user.Role?.Name ?? "No Role"))</span>
                                </label>
                            }
                        </div>
                    }
                    else
                    {
                        <p>No users available for assignment.</p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseAssignUsersModal">Close</button>
                    <button type="button" class="btn btn-primary" @onclick="AssignUsersToCompany">Assign Selected Users</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string id { get; set; }

    public int CompanyId => Convert.ToInt32(id);

    private bool showCommentModal = false;
    private bool showTicketModal = false;
    private bool showAddTicketModal = false;
    private bool showTicketDetailsModal = false;
    private Company company;
    private List<Ticket> tickets;
    private Ticket selectedTicket;
    private AccessContext accessContext = new AccessContext();
    private string message = "";
    private List<ApplicationUser> availableUsers = new();
    private HashSet<string> selectedUserIds = new();
    private string assignMessage = "";
    private bool showAssignUsersModal = false;
    private string userSearch = "";
    private List<CompanyFile> companyFiles = new();
    private string fileMessage = "";
    private const string DefaultFileIconUrl = "/images/file-default.png";

    private void OpenCommentModal()
    {
        showCommentModal = true;
    }

    private void CloseCommentModal()
    {
        showCommentModal = false;
    }

    private void OpenAddTicketModal()
    {
        showAddTicketModal = true;
    }

    private void CloseAddTicketModal()
    {
        showAddTicketModal = false;
        _ = LoadTickets();
    }


    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            accessContext = await accessControlService.GetAccessContextAsync(authState.User);

            int companyID = Convert.ToInt32(id);
            company = await companyService.GetCompanyByIdAsync(companyID);

            if (!accessContext.CanAccessCompany(companyID))
            {
                message = "You are not authorized to view this company.";
                company = null;
                tickets = new List<Ticket>();
                return;
            }

            await LoadTickets();
            await LoadAssignableUsers();
            await LoadCompanyFiles();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred: {ex.Message}");
        }
    }

    private async Task LoadTickets()
    {
        try
        {
            int companyID = Convert.ToInt32(id);
            tickets = await companyService.GetActiveTicketsbyCompanyIdAsync(companyID);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"An error occurred: {ex.Message}");
        }
    }

    private async Task LoadCompanyFiles()
    {
        if (company == null)
            return;

        companyFiles = await companyFileService.GetFilesForCompanyAsync(company.Id);
    }

    private void ShowTicketDetails(Ticket ticket)
    {
        selectedTicket = ticket;
        showTicketDetailsModal = true;
    }

    private string GetSeverityCssClass(string severity)
    {
        switch (severity.ToLower())
        {
            case "low":
                return "bg-success";
            case "medium":
                return "bg-warning";
            case "high":
                return "bg-danger";
            default:
                return "";
        }
    }

    private async Task HandleCompanyFileSelected(InputFileChangeEventArgs e)
    {
        fileMessage = "";
        if (company == null)
        {
            fileMessage = "Company not loaded.";
            return;
        }

        if (!accessContext.CanAccessCompany(company.Id))
        {
            fileMessage = "You are not authorized to upload files to this company.";
            return;
        }

        try
        {
            foreach (var file in e.GetMultipleFiles())
            {
                await companyFileService.UploadCompanyFileAsync(company.Id, company.Name, file);
            }

            await LoadCompanyFiles();
            fileMessage = "File(s) uploaded successfully.";
        }
        catch (Exception ex)
        {
            fileMessage = $"Upload failed: {ex.Message}";
        }
    }

    private async Task DeleteCompanyFile(int fileId)
    {
        fileMessage = "";
        if (company == null)
        {
            fileMessage = "Company not loaded.";
            return;
        }

        if (!(accessContext.IsAdmin || accessContext.IsManager))
        {
            fileMessage = "You are not authorized to delete files for this company.";
            return;
        }

        var deleted = await companyFileService.DeleteCompanyFileAsync(company.Id, fileId);
        fileMessage = deleted ? "File deleted." : "File not found.";
        await LoadCompanyFiles();
    }

    private async Task LoadAssignableUsers()
    {
        if (!(accessContext.IsAdmin || accessContext.IsManager))
            return;

        availableUsers = await userManager.Users
            .Include(u => u.Role)
            .ToListAsync();

        if (!accessContext.IsAdmin)
        {
            availableUsers = availableUsers
                .Where(u => u.Role?.Name == "User" || u.Role?.Name == "Developer")
                .ToList();
        }
    }

    private IEnumerable<ApplicationUser> FilteredUsers
    {
        get
        {
            var query = string.IsNullOrWhiteSpace(userSearch)
                ? availableUsers
                : availableUsers.Where(u =>
                    (!string.IsNullOrWhiteSpace(u.FullName) && u.FullName.Contains(userSearch, StringComparison.OrdinalIgnoreCase)) ||
                    (!string.IsNullOrWhiteSpace(u.Email) && u.Email.Contains(userSearch, StringComparison.OrdinalIgnoreCase)) ||
                    (!string.IsNullOrWhiteSpace(u.LastName) && u.LastName.Contains(userSearch, StringComparison.OrdinalIgnoreCase)) ||
                    (!string.IsNullOrWhiteSpace(u.FirstName) && u.FirstName.Contains(userSearch, StringComparison.OrdinalIgnoreCase)));

            return query
                .OrderBy(u => u.LastName)
                .ThenBy(u => u.FirstName);
        }
    }

    private void ToggleUserSelection(string userId, ChangeEventArgs e)
    {
        var isChecked = e.Value switch
        {
            bool b => b,
            string s => string.Equals(s, "true", StringComparison.OrdinalIgnoreCase),
            _ => false
        };

        if (isChecked)
        {
            selectedUserIds.Add(userId);
        }
        else
        {
            selectedUserIds.Remove(userId);
        }
    }

    private async Task AssignUsersToCompany()
    {
        assignMessage = "";
        if (company == null)
        {
            assignMessage = "Company not loaded.";
            return;
        }

        if (selectedUserIds.Count == 0)
        {
            assignMessage = "Select at least one user.";
            return;
        }

        try
        {
            await companyService.AssignUsersToCompanyAsync(company.Id, selectedUserIds.ToList());
            selectedUserIds.Clear();
            company = await companyService.GetCompanyByIdAsync(company.Id);
            assignMessage = "Users assigned successfully.";
        }
        catch (Exception ex)
        {
            assignMessage = $"Unable to assign users: {ex.Message}";
        }
    }

    private void OpenAssignUsersModal() => showAssignUsersModal = true;
    private void CloseAssignUsersModal() => showAssignUsersModal = false;

    private void NavigateToList()
    {
        navigationManager.NavigateTo("/companies");
    }
}
